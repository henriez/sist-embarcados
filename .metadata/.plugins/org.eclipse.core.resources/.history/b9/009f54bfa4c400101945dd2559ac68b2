#include "hc12.h"
#include <string.h>

// This module assumes huart1 is already initialized in main.c
extern UART_HandleTypeDef huart1;

#pragma pack(push, 1)
typedef struct {
    uint8_t startByte;
    uint8_t deviceId;
    float   x;
    float   y;
    float   z;
    float   dist;
    uint8_t checksum;
} DataPacket;
#pragma pack(pop)

#define MY_START_BYTE 0xAA
#define MY_DEVICE_ID  0x42


void HC12_sendData(float x, float y, float z, float dist) {
    DataPacket pkt;
    pkt.startByte = MY_START_BYTE;
    pkt.deviceId  = MY_DEVICE_ID;
    pkt.x = x;
    pkt.y = y;
    pkt.z = z;
    pkt.dist = dist;

    uint8_t *ptr = (uint8_t*)&pkt;
    pkt.checksum = 0;
    for(int i = 0; i < sizeof(DataPacket) - 1; i++) {
        pkt.checksum ^= ptr[i];
    }

    HAL_UART_Transmit(&huart1, (uint8_t*)&pkt, sizeof(DataPacket), 100);
}
